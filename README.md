# ST77xxDMA — библиотека для быстрых TFT‑дисплеев ST77xx (DMA)

Библиотека **ST77xxDMA** предназначена для работы с цветными TFT‑дисплеями на контроллерах семейства **ST77xx** с поддержкой **DMA** и полноэкранного фреймбуфера.

Основной фокус — высокая скорость, удобный API и нормальная работа с текстом (включая UTF‑8 и кириллицу).

## Возможности

- **Контроллеры**:
  - `ST7735`
  - `ST7789`
  - `NV3007`
- **Готовые пресеты панелей** (`ST77xxPanel`):
  - `ST7735_128x160` — 1.8" 128×160
  - `ST7735_80x160`  — 0.96" 80×160
  - `ST7789_240x320` — 2.0" 240×320
  - `ST7789_240x240` — 1.54" 240×240
  - `ST7789_170x320` — 1.9" 170×320
  - `ST7789_172x320` — 1.47" 172×320
  - `ST7789_76x284`  — 2.25" 76×284
  - `NV3007_428x142` — 1.65" 428×142
- **Аппаратный и программный SPI**:
  - аппаратный SPI с настройкой частоты до десятков МГц (ESP32/RP2040 и др.);
  - программный SPI (bit‑bang) с оптимизациями под разные MCU.
- **DMA и фреймбуфер**:
  - полноэкранный RGB565 фреймбуфер (опционально);
  - передача содержимого фреймбуфера по SPI/DMA одной командой `flush()`;
  - частичные обновления `flushRect(x, y, w, h)`.
- **Управление подсветкой и яркостью**:
  - внешний пин подсветки `BL` (PWM) для любых контроллеров;
  - панельная яркость через MIPI DCS (`ST7789`) для модулей без BL‑пина;
  - единый API `setBrightness(0..255)`, который сам выбирает способ.
- **Текст и шрифты**:
  - поддержка шрифтов формата **Adafruit GFX / TFT_eSPI GFXFF**;
  - потоковый вывод UTF‑8 (включая кириллицу) через `Print`/`drawTextUTF8`;
  - настраиваемый межбуквенный интервал (`setLetterSpacing`).
- **Примитивы рисования**:
  - пиксели, линии, прямоугольники, круги, треугольники, скруглённые рамки;
  - битмапы (1‑бит и RGB565).
- **Дополнительно**:
  - поворот экрана `setRotation(0..3)` и зеркалирование `setMirror()`;
  - инверсия цветов `setInversion(true/false)`;
  - TE‑сигнал, вертикальный скролл, частичный режим отображения;
  - продвинутые настройки для **RP2040** (PIO+DMA, поднятие частоты шин).


## Установка

### Arduino IDE

1. Склонировать или скачать репозиторий в папку `libraries` Arduino:

   - путь обычно: `Документы/Arduino/libraries/ST77xxDMA`
   - структура должна быть такой, чтобы в папке библиотеки лежали `src/`, `library.properties`, `README.md` и т.п.

2. Перезапустить Arduino IDE.
3. Библиотека появится в списке **Скетч → Подключить библиотеку**.

### PlatformIO

Добавьте библиотеку как Git‑зависимость или локальную библиотеку, например:

```ini
lib_deps =
    https://github.com/Atmel2005/ST77xx_DMA.git
```

Либо скопируйте папку библиотеки в `lib/` вашего проекта.


## Быстрый старт

### 1. Базовая инициализация

Минимальный пример для дисплея **ST7789 170×320** (аналогично для других панелей):

```cpp
#include <ST77xxDMA.h>

ST77xxDMA* tft;

void setup() {
  ST77xxConfig cfg;

  // Выбираем панель (см. список пресетов выше)
  cfg.panel = ST77xxPanel::ST7789_170x320;

  // SPI
  cfg.use_hw_spi = true;   // аппаратный SPI
  cfg.spi_hz     = 80;     // 80 МГц (значения <=512 трактуются как МГц)

  // Ориентация и базовые опции
  cfg.rotation   = 1;      // 0..3
  cfg.allocate_framebuffer = true; // полноэкранный фреймбуфер (рекомендуется)

  // Пины (пример — под вашу плату подставьте свои)
  cfg.dc  = PIN_DC;        // D/C (обязателен)
  cfg.cs  = PIN_CS;        // CS (желательно не использовать автоселект SPI)
  cfg.rst = PIN_RST;       // RST (можно -1, если аппаратный сброс не нужен)
  cfg.bl  = PIN_BL;        // пин подсветки (>=0, если есть внешний BL)

  tft = new ST77xxDMA(cfg);
  tft->begin();

  // Короткий глобальный API через namespace ST77xx
  ST77xx::setDefault(tft);

  ST77xx::setRotation(cfg.rotation);
  ST77xx::setBGR(cfg.bgr);
  ST77xx::setBrightness(160);   // общая яркость 0..255

  ST77xx::fillScreen(ST77xx::C::Black);
  ST77xx::flush();
}

void loop() {
  // Ваш код
}
```

### 2. Выбор панели

Главный параметр — `cfg.panel`:

```cpp
cfg.panel = ST77xxPanel::ST7789_240x320; // 2.0" 240×320
// или
cfg.panel = ST77xxPanel::ST7789_240x240; // 1.54" 240×240
// или
cfg.panel = ST77xxPanel::ST7789_135x240; // 1.14" 135×240
// или
cfg.panel = ST77xxPanel::ST7735_80x160;  // 0.96" 80×160
```

Контроллер (`cfg.controller`) подбирается автоматически по типу панели.
При необходимости можно задать собственные `width/height/colstart/rowstart`,
если ваш модуль имеет отличающуюся разметку видеопамяти.


## Конфигурация `ST77xxConfig`

Структура `ST77xxConfig` описывает все параметры панели и подключения.
Ниже — основные поля (см. `src/ST77xxDMA.h` для полного списка).

### Базовые параметры

- `ST77xxController controller` — тип контроллера
  (`ST7735`, `ST7789`, `NV3007`). Обычно заполняется автоматически.
- `ST77xxPanel panel` — пресет панели (см. список выше).
- `uint16_t width`, `height` — логические размеры; если `0`, берутся из пресета.
- `uint8_t colstart`, `rowstart` — смещения области отображения внутри RAM панели.
- `bool bgr` — порядок цветов (false = RGB, true = BGR).
- `uint8_t rotation` — поворот 0..3 (по часовой стрелке).

### Пины

- `int8_t mosi`, `miso`, `sclk` — пины SPI (используются в SW SPI и на некоторых платформах).
- `int8_t cs`  — Chip Select дисплея.
- `int8_t dc`  — Data/Command.
- `int8_t rst` — Reset (-1, если не используется).
- `int8_t bl`  — пин подсветки (PWM). `-1`, если внешнего BL‑пина нет.

### Подсветка (PWM через BL‑пин)

- `bool bl_invert` — инвертирование ШИМ (true: 0 = максимальная яркость).
- `uint32_t bl_freq_hz` — частота PWM (ESP32/ESP8266/RP2040).
- `uint8_t bl_ledc_channel` — канал LEDC на ESP32.
- `uint8_t bl_start` — стартовый уровень яркости 0..255.

После `begin()` можно управлять подсветкой:

```cpp
ST77xx::setBrightness(200); // единый API (предпочтительно)
// или
ST77xx::setBacklight(200);  // напрямую через BL‑пин
```

### Панельная яркость (ST7789 без BL‑пина)

Если `cfg.bl < 0` и контроллер `ST7789`, библиотека использует MIPI DCS–команды
для яркости матрицы:

- `cfg.panel_brightness_start` — стартовый уровень 0..255.

В коде:

```cpp
ST77xx::setBrightness(120);      // будет использовать панельную яркость
// низкоуровневые вызовы при необходимости:
// ST77xx::enablePanelBrightness(true);
// ST77xx::setPanelBrightness(120);
```

### SPI

- `bool use_hw_spi` — `true` для аппаратного SPI, `false` для SW SPI.
- `uint32_t spi_hz` — целевая частота SPI в Гц;
  - если значение ≤ 512 — трактуется как МГц (80 → 80 МГц).
- `bool sw_spi_use_asm` — использовать оптимизированный ASM‑вариант SW SPI (где доступно).
- `bool sw_spi_direct_gpio` — прямой доступ к GPIO вместо `digitalWrite`.

### RP2040 и PIO

Для **RP2040** доступны дополнительные параметры:

- `bool rp2040_use_pio` — использовать PIO+DMA (режим в разработке).
- `bool rp2040_auto_raise_clk_peri` — привязать `clk_peri` к текущему `clk_sys`.
- `uint32_t rp2040_target_sysclk_khz` — явно задать частоту `clk_sys` (в кГц).
- `int8_t rp2040_spi_index` — выбор SPI‑контроллера (-1 = авто, 0 = SPI0, 1 = SPI1).
- `bool rp2040_force_gpio_func` — принудительно выставить функцию пинов в `GPIO_FUNC_SPI`.

### Память и отладка

- `bool allocate_framebuffer` — выделить полный фреймбуфер (рекомендуется для DMA).
- `uint16_t txbuf_lines` — опциональный небольшой передающий буфер (ESP8266).
- `bool debug` — вывод отладочных логов в Serial.


## Рисование и текст

После `ST77xx::setDefault(tft)` можно использовать удобный глобальный API.

### Базовые примитивы

```cpp
using namespace ST77xx;

fillScreen(C::Black);
drawPixel(10, 10, C::Red);
drawFastHLine(0, 20, 100, C::Green);
drawRect(10, 30, 50, 20, C::Yellow);
fillRect(70, 30, 40, 20, C::Blue);
flush();
```

### Текст

```cpp
using namespace ST77xx;

setCursor(10, 50);
setTextColor(C::White, C::Black);
setTextSize(2);
print("Hello, ST77xx!");
flush();
```

Для UTF‑8 и GFX‑шрифтов см. примеры в папке `examples/` и файл
`ST77xxDMA_USAGE_RU.txt` (описаны `setGFXFont`, `drawTextUTF8` и пр.).


## Расширенные функции дисплея

- **TE (Tearing Effect)**:
  - `setTE(bool enable, uint8_t mode = 0x00);`
  - `setTEScanline(uint16_t line);`
- **Вертикальная прокрутка**:
  - `setScrollDefinition(tfa, vsa, bfa);`
  - `setScroll(y);`
- **Частичный режим**:
  - `setPartialArea(y0, y1);`
  - `setPartialMode(true/false);`
- **Клип‑область**:
  - `setClipRect(x, y, w, h);`
  - `resetClipRect();`

Все эти функции имеют как методы класса `ST77xxDMA`, так и удобные
обёртки в `namespace ST77xx`.


## Примеры

В папке `examples/` есть несколько скетчей, демонстрирующих:

- базовую инициализацию и тест производительности (`FpsTest`);
- работу с NV3007 (`NV3007_Intro`);
- проверку всех размеров GFX‑шрифтов (`FontAllSizesValidation`);
- пример для RP2040 PIO+DMA (`RP2040_PIO_DMA_9bit_Min`).

Рекомендуется начать с `FpsTest` и адаптировать конфигурацию `ST77xxConfig`
под ваш модуль (панель, пины, частота SPI и яркость).

---

